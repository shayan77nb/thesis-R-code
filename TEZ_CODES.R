rm(list = ls())
######Libries#####
library("rio")
library("caTools")
library("tidyverse")
library("tidyr")
library("dplyr")
library("ggplot2")
library("readxl")
library("pastecs")
library("psych")
library("energy")
library("stargazer")
library("e1071")
library("rpart")
library("rpart.plot")
library("randomForest")
library("caret")
library("pROC")
#####Import DATA####
mydata = read_excel("C:/Users/TechLand/Desktop/Data.xlsx")

#####???????? ?????? ???? ???????? ????#####
str(mydata)
summary(mydata)
head(mydata)
tail(mydata)
View(mydata)

#####?????????? ???????? ???????? ???????? ????####
mydata $ Status %>% length()
mydata $ Status  %>% unique() %>% length()

#####??????????_????????_??????_??????????_????_????????_?????? ????????####
mydata2 = spread(mydata , key = Year , value = Status)

#####????????????_????????_????????_????####
str(mydata)
mode(mydata$Status)
mode(mydata$BMI)
range(mydata$Status)

#####?????????? ?????????????? ???? ?????? ??  ??????????####
mydata$sex[mydata$sex == 1] = "Male"
mydata$sex[mydata$sex == 0] = "Female"
mydata %>% mutate(sex = as.factor(sex)) %>% str()
mydata$sex = as.factor(mydata$sex)

mydata$restecg[mydata$restecg == 0] = "Normal"
mydata$restecg[mydata$restecg == 1] = "Problem"
mydata$restecg = as.factor(mydata$restecg)
#####Check_data frame####
is.data.frame(mydata)

#####?????????? ???????? ???????? ???? ???????? ???? ???? ?????? ???? ?????????? ????????####
domain_test = mydata$BMI < 29.5 & mydata$BMI > 18.5
domain_test %>% table()
range(mydata$`HIV/AIDS`)
domain_test = mydata$`HIV/AIDS` < 45 & mydata$`HIV/AIDS`>5
domain_test %>% table()
mydata %>% filter(mydata$`HIV/AIDS` < 45 & mydata$`HIV/AIDS`>5) %>% nrow()
mydata %>% filter(mydata$`HIV/AIDS` < 45 & mydata$`HIV/AIDS`>5) -> mydata_fill

####?????????? ???????? ?????? ????????????#####
a = summary(mydata$cp)
skewness <- ((q[3]- q[2])-(q[2]- q[1]))/(q[3]-q[1])
stat.desc(mydata$cp)
describe(mydata$cp)
describe.by(mydata$cp , group = mydata$sex)

######??????????_?????????? ???? ??????####
date = c("2024-3-11" , "2024-3-16")
diffdate = difftime(date[2] , date[1] , units = "days")
diff_time = as.numeric(diffdate)

mydata %>%
  mutate(delays = diff_time) =
  mydata_new

##### ?????? ???????????? ??????????????????####
ggplot(data = mydata , mapping = aes(x = mydata$chol , fill = mydata$sex , 
                                     y = after_stat(density))) + 
  geom_histogram(alpha = 0.5) +
  geom_density(alpha = 0.1) + 
  labs(title = "Histogram for Cholstrol" , x = "chol" , y = "Frequency")

#####?????? ???????????? ???????? ????####

ggplot(data = mydata , mapping = aes(x = mydata$chol , y = mydata$sex 
                                     , fill = sex)) + 
  geom_boxplot() +
  labs(title = "Box plot for Cholstrol" , 
       fill = "Pattern Sex" ,
       x = "Chol" , 
       y = "Sex")

#####???????????? ???????? ????####

ggplot(data = mydata , mapping = aes(x =  sex , fill =  sex )) + 
  geom_bar() +
  labs(title = "Bar plot for Sex" , x = "Sex" , y = "Frequency")

ggplot(data = mydata , mapping = aes(x =  sex , fill =  sex , 
                                     y = 100 * (after_stat(count)) /
                                       sum(after_stat(count)))) + 
  geom_bar() +
  labs(title = "Bar plot for Sex" , x = "Sex" , y = "Pre(%)")
#####????????????  ???????? ???? ???????? ???????? ??????####
ggplot(data = mydata , mapping = aes(x =  sex , fill = restecg , 
                                     y = 100 * (after_stat(count)) /
                                       sum(after_stat(count)))) + 
  geom_bar(position = "fill") +
  labs(title = "Bar plot for Sex" , x = "Sex" , y = "Pre(%)")

ggplot(data = mydata , mapping = aes(x =  sex , fill = restecg ))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), 
           position="dodge" ) +
  labs(title = "Bar plot for Sex" , x = "Sex" , y = "Pre(%)")
#####???????????? ????????????####

ggplot(data = mydata , mapping = aes(x = chol,
                                     y = age,
                                     color = restecg)) + 
  geom_point() +
  geom_jitter()+
  facet_wrap(~restecg)+
  theme_light()
  #labs(title = "Bar plot for Sex" , x = "Sex" , y = "Frequency")

######training_testing_data####
set.seed(402)
sample = sample(c(FALSE , TRUE) , nrow(mydata) , replace = TRUE ,
                prob = c(0.2 , 0.8))
train_data = mydata[sample,]
test_data = mydata[!sample,]

#intrain <- createDataPartition(y = mydata$exang, p= 0.8, list = FALSE)
#training <- mydata[intrain,]
#testing <- mydata[-intrain,]

#########?????????? ?????????????? ????????????#####
mylr = glm(as.numeric(exang) ~ . , data = train_data 
                 , family = "binomial")
summary(mylr)
#####?????????? ???????????? ?????? ????????????####
mylr_power2 = glm(as.numeric(exang) ~ . + age^2 + trestbps^2 + chol^2 + 
                          thalach^2 + oldpeak^2
                        , data = train_data 
                        , family = "binomial")
stargazer(mylr_power2 , mylr , title="Results", type = "text"
          , align=TRUE)
#####?????? ???????????? ?????? ????????????####
mylr$model %>%
  select(cp) %>%
  cbind(probability = mylogistic$fitted.values,.)-> dataviz_dataset
dataviz_dataset %>%
  ggplot(aes(x = cp , y = probability)) +
  geom_point()

#####?????????????? ?????? ?????????????? ????????????####
test_data = na.omit(test_data)
predicted_lr = predict(mylr , test_data , type = "response")
predicted_classes = ifelse(predicted_lr > 0.5 , 1 , 0)
observation = test_data$exang
cm_lr = confusionMatrix(as.factor(observation), 
                               as.factor(predicted_classes))
#accuracy_lr = cm_lr$overall['Accuracy']
#precision_lr = cm_lr$byClass['Pos Pred Value']
#recall_lr = cm_lr$byClass['Sensitivity']
#f1_score_lr = cm_lr$byClass['F1']
#roc_score_lr = roc(observation , predicted_classes)
#plot(roc_score_lr , main = "ROC -- Logistic Regression")

######?????????? ?????? ?????????? ?????????? ??????????????####
mysvm = svm(as.factor(exang) ~ . , 
            data = train_data , type = "C" , kernel = "linear")
mysvm

#####?????????? ?????????????? ???? ?????????? ?????????? ??????????????####
weight = t(mysvm$coefs) %*%
  mysvm$SV
sd(weight)
weight %>% abs %>% as.data.frame() %>% sort(decreasing = TRUE)

#####???????????? ???????????? ?????????? ?????????? ??????????????####
predicted_svm = predict(mysvm , test_data , type = "response")
observation = test_data$exang
cm_svm = confusionMatrix(as.factor(observation),
                        as.factor(predicted_svm))

#####?????????? ?????? ???????? ??????????####
mydt = rpart(as.factor(exang) ~ . , method = "class"
             ,data = mydata , parms=list(split="information"))
printcp(mydt)
summary(mydt)

#####?????? ???????? ??????????####
rpart.plot(mydt)

#####?????????? ?????????? ?????????????? ???? ???????? ??????????####
df = data.frame(imp = mydt$variable.importance)
df2 = df %>% 
  rownames_to_column() %>% 
  rename("variable" = rowname) %>% 
  arrange(imp) %>%
  mutate(variable = forcats::fct_inorder(variable))
ggplot(df2) +
  geom_col(aes(x = variable, y = imp),
           col = "black", show.legend = F) +
  coord_flip() +
  scale_fill_grey() +
  theme_bw()

#####???????????? ???????????? ???????? ??????????####
predicted_dt = predict(mydt , test_data , type = "class")
observation = test_data$exang
cm_dt = confusionMatrix(as.factor(observation),
                         as.factor(predicted_dt))


#####?????????? ?????? ???????? ????????????####
train_data = na.omit(train_data)
set.seed(402)
myrf = randomForest(as.factor(exang) ~ . , data = train_data , 
                    importance = TRUE)

myrf

######?????? ???????? ????????????####
plot(myrf)

#####?????????? ???????? ?????????????? ???? ???????? ????????????####
varImpPlot(myrf)

#####???????????? ???????????? ???????? ????????????####
predicted_rf = predict(myrf , test_data , type = "class")
observation = test_data$exang
cm_rf = confusionMatrix(as.factor(observation),
                        as.factor(predicted_rf))
cm_rf
 
#####???????????? ?????????? ?????? ???? ???????????????? ????####
acuracy_lr = cm_lr$overall['Accuracy']
acuracy_svm = cm_svm$overall['Accuracy']
acuracy_dt = cm_dt$overall['Accuracy']
acuracy_rf = cm_rf$overall['Accuracy']

data1 = data.frame(model = c("logistic",
                             "support_vector",
                             "decision_tree",
                             "random_forest"),
                   acuracy = c(acuracy_lr , acuracy_svm,
                               acuracy_dt , acuracy_rf))
ggplot(data = data1, aes(x = acuracy,y = model, label =
                           round(acuracy,2) ))+
  geom_bar(stat = 'identity')+
  geom_text(size = 5 , position=position_dodge(width=0.9),
            hjust=1.5,colour="white")


#####???????????? ?????????? ?????? ???? ???????????????? ????####

precision_lr = cm_lr$byClass['Pos Pred Value']
precision_svm = cm_svm$byClass['Pos Pred Value']
precision_dt = cm_dt$byClass['Pos Pred Value']
precision_rf = cm_rf$byClass['Pos Pred Value']

data2 = data.frame(model = c("logistic",
                             "support_vector_machine",
                             "decision_tree",
                             "random_forest"),
                   precision = c(precision_lr , precision_svm,
                                 precision_dt , precision_rf))
ggplot(data = data2, aes(x = precision , y = model, label =
                           round(precision , 2) ))+
  geom_bar(stat = 'identity')+
  geom_text(size = 5 , position=position_dodge(width=0.9),
            hjust=1.5,colour="white")

######???????????? ?????????? ???????? ???? ???????????????? ????#####
recall_lr = cm_lr$byClass['Sensitivity']
recall_svm = cm_svm$byClass['Sensitivity']
recall_dt = cm_dt$byClass['Sensitivity']
recall_rf = cm_rf$byClass['Sensitivity']

data3 = data.frame(model = c("logistic",
                             "support_vector_machine",
                             "decision_tree",
                             "random_forest"),
                   recall = c(recall_lr , recall_svm,
                              recall_dt , recall_rf))

ggplot(data = data3, aes(x = recall , y = model, label =
                           round(recall , 2) ))+
  geom_bar(stat = 'identity')+
  geom_text(size = 5 , position=position_dodge(width=0.9),
            hjust=1.5,colour="white")

######???????????? ?????????? ???? ???? ???? ???????????????? ????####
f1_score_lr = cm_lr$byClass['F1']
f1_score_svm = cm_svm$byClass['F1']
f1_score_dt = cm_dt$byClass['F1']
f1_score_rf = cm_rf$byClass['F1']

data4 = data.frame(model = c("logistic",
                             "support_vector_machine",
                             "decision_tree",
                             "random_forest"),
                   f1_score= c(f1_score_lr , f1_score_svm,
                               f1_score_dt , f1_score_rf))

ggplot(data = data4, aes(x = f1_score , y = model, label =
                           round(f1_score , 2) ))+
  geom_bar(stat = 'identity')+
  geom_text(size = 5 , position=position_dodge(width=0.9),
            hjust=1.5,colour="white")
